<!DOCTYPE html>

<html class="h-100"
      lang="en"
      dir="ltr">

<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <meta charset="utf-8">
</head>

<body class="h-100 d-flex align-items-center flex-column justify-content-center w-100">
  <div class="border d-grid p-3 shadow">
    <h6 id="title"></h6>
    <p class="mb-0" id="subtitle"></p>
    <hr>
    <div class="d-flex justify-content-end mb-3">
      Documents copropriété :&nbsp;
      <lr-file-uploader-regular
        css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
        ctx-name="/Documents de vente/Documents copropriete/"
        class="my-config"
      ></lr-file-uploader-regular>
    </div>
    <div class="d-flex justify-content-end mb-3">
      Documents opportunité :&nbsp;
      <lr-file-uploader-regular
        css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
        ctx-name="/Documents de vente/Documents opportunite/"
        class="my-config"
      ></lr-file-uploader-regular>
    </div>
    <div class="d-flex justify-content-end mb-3">
      Visuel n°1 :&nbsp;
      <lr-file-uploader-regular
        css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
        ctx-name="/Visuel 1/"
        class="my-config"
      ></lr-file-uploader-regular>
    </div>
    <div class="d-flex justify-content-end mb-3">
      Visuel n°2 :&nbsp;
      <lr-file-uploader-regular
        css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
        ctx-name="/Visuel 2/"
        class="my-config"
      ></lr-file-uploader-regular>
    </div>
    <div class="d-flex justify-content-end mb-3">
    Visuel n°3 :&nbsp;
      <lr-file-uploader-regular
        css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
        ctx-name="/Visuel 3/"
        class="my-config"
      ></lr-file-uploader-regular>
    </div>
    <div class="d-flex justify-content-end mb-3">
      Visuel n°4 :&nbsp;
      <lr-file-uploader-regular
        css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
        ctx-name="/Visuel 4/"
        class="my-config"
      ></lr-file-uploader-regular>
    </div>
    <div class="d-flex justify-content-end mb-3">
      Visuel n°5 :&nbsp;
      <lr-file-uploader-regular
        css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
        ctx-name="/Visuel 5/"
        class="my-config"
      ></lr-file-uploader-regular>
    </div>
    <div class="d-flex justify-content-end mb-3">
      Visuel n°6 :&nbsp;
      <lr-file-uploader-regular
        css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
        ctx-name="/Visuel 6/"
        class="my-config"
      ></lr-file-uploader-regular>
    </div>
    <div class="d-flex justify-content-end">
      Autre :&nbsp;
      <lr-file-uploader-regular
        css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
        ctx-name="/Autre/"
        class="my-config"
      ></lr-file-uploader-regular>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let product = {};
    let token = '';

    const getProduct = async _ => {
      const response = await fetch(
        'https://immocitiz.pipedrive.com/api/v1/products/' +
        new URLSearchParams(window.location.search).get('id') +
        '?api_token=' +
        new URLSearchParams(window.location.search).get('p')
      );
      let responeJson = await response.json();
      product = responeJson.data;
      document.getElementById("title").innerHTML = product.name;
      document.getElementById("subtitle").innerHTML =
        'sourcé par ' +
        product.d2c362a22b4628842cb19563a4fd19337b27189e.name +
        ' le ' +
        new Date(product.add_time).toLocaleDateString('fr-FR');
    };
    getProduct();

    const getToken = async _ => {
      const response = await fetch('https://api.sirv.com/v2/token', {
        method: 'POST',
        body: JSON.stringify({
          "clientId": new URLSearchParams(window.location.search).get('s1'),
          "clientSecret": new URLSearchParams(window.location.search).get('s2')
        }),
        headers: {
          'content-type': 'application/json'
        }
      });
      let responseJson = await response.json();
      token = responseJson.token;
    }
    getToken();

    const getImageAsBinary = async url => {
      try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const binaryContent = new Uint8Array(arrayBuffer);
        return binaryContent;
      } catch (error) {
        console.error('Error:', error);
        return null;
      }
    }

    const uploadFile = async (e, element, binaryContent) => {
      const response = await fetch(
        'https://api.sirv.com/v2/files/upload?filename=%2F' + product.d74428a0196cace86d45a83a9526935ffe7b2415.substring(29).replace('/', '%2F') + e.detail.ctx + element.name, {
          method: 'POST',
          body: binaryContent,
          headers: {
            'content-type': element.mimeType,
            'authorization': token
          }
        }
      );
    }

    window.addEventListener('LR_DATA_OUTPUT', e => {
      e.detail.data.forEach(element => {
        getImageAsBinary(element.cdnUrl)
          .then(binaryContent => uploadFile(e, element, binaryContent))
          .catch(error => console.error('Error:', error));
      });
    });
  </script>

  <script type="module">
    import * as LR from "https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.js";

    LR.registerBlocks(LR);
  </script>

  <style>
    .my-config {
      --cfg-pubkey: "e2d5f890d44d15ce657b";
      --cfg-img-only: 1;
      --cfg-multiple: 1;
      --cfg-max-local-file-size-bytes: 10485760;
      --cfg-use-cloud-image-editor: 1;
      --cfg-source-list: "local, url, camera, dropbox, facebook, gdrive, gphotos, instagram";
      --darkmode: 0;
      --h-accent: 223;
      --s-accent: 100%;
      --l-accent: 61%;
    }
  </style>
</body>

</html>
