<!DOCTYPE html>

<html class="h-100"
      lang="en"
      dir="ltr">

<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <meta charset="utf-8">
</head>

<body class="d-flex align-items-center flex-column p-3 w-100" style="background-color: #eee;">
  <div class="w-75">
    <div class="d-flex align-items-center mb-3">
      <img class="img-thumbnail mr-3 shadow" src="https://avatars.githubusercontent.com/u/122356874?s=50">
      <h1>&nbsp;Immocitiz File Uploader</h1>
    </div>
    <div class="bg-light border d-grid mb-3 p-3 shadow">
      <h6 id="title"></h6>
      <p class="mb-0" id="subtitle"></p>
      <hr>
      <h6 class="mb-3">Documents copropriété :</h6>
      <lr-file-uploader-regular
        css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
        ctx-name="/Documents de vente/Documents copropriete/"
        class="no-multiple-max"
      ></lr-file-uploader-regular>
      <div class="d-flex flex-wrap" id="/Documents de vente/Documents copropriete"></div>
      <hr>
      <h6 class="mb-3">Documents opportunité :</h6>
      <lr-file-uploader-regular
        css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
        ctx-name="/Documents de vente/Documents opportunite/"
        class="no-multiple-max"
      ></lr-file-uploader-regular>
      <div class="d-flex flex-wrap" id="/Documents de vente/Documents opportunite"></div>
      <hr>
      <h6>Visuels :</h6>
      <div class="d-flex flex-wrap">
        <div class="d-flex flex-column gap-3 p-3 w-50">
          <div id="/Visuel 1"></div>
          <lr-file-uploader-regular
            css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
            ctx-name="/Visuel 1/"
            class="multiple-max-1"
          ></lr-file-uploader-regular>
        </div>
        <div class="d-flex flex-column gap-3 p-3 w-50">
          <div id="/Visuel 2"></div>
          <lr-file-uploader-regular
            css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
            ctx-name="/Visuel 2/"
            class="multiple-max-1"
          ></lr-file-uploader-regular>
        </div>
        <div class="d-flex flex-column gap-3 p-3 w-50">
          <div id="/Visuel 3"></div>
          <lr-file-uploader-regular
            css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
            ctx-name="/Visuel 3/"
            class="multiple-max-1"
          ></lr-file-uploader-regular>
        </div>
        <div class="d-flex flex-column gap-3 p-3 w-50">
          <div id="/Visuel 4"></div>
          <lr-file-uploader-regular
            css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
            ctx-name="/Visuel 4/"
            class="multiple-max-1"
          ></lr-file-uploader-regular>
        </div>
        <div class="d-flex flex-column gap-3 p-3 w-50">
          <div id="/Visuel 5"></div>
          <lr-file-uploader-regular
            css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
            ctx-name="/Visuel 5/"
            class="multiple-max-1"
          ></lr-file-uploader-regular>
        </div>
        <div class="d-flex flex-column gap-3 p-3 w-50">
          <div id="/Visuel 6"></div>
          <lr-file-uploader-regular
            css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
            ctx-name="/Visuel 6/"
            class="multiple-max-1"
          ></lr-file-uploader-regular>
        </div>
      </div>
      <hr>
      <h6 class="mb-3">Autres visuels :</h6>
      <lr-file-uploader-regular
        css-src="https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.css"
        ctx-name="/Autre/"
        class="no-multiple-max""
      ></lr-file-uploader-regular>
      <div class="d-flex flex-wrap" id="Autre"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let product = {};
    let token = '';

    const getProduct = async _ => {
      const response = await fetch(
        'https://immocitiz.pipedrive.com/api/v1/products/' +
        new URLSearchParams(window.location.search).get('id') +
        '?api_token=' +
        new URLSearchParams(window.location.search).get('p')
      );
      let responeJson = await response.json();
      product = responeJson.data;
      document.getElementById('title').innerHTML = product.name;
      document.getElementById('subtitle').innerHTML += 'sourcé par ';
      document.getElementById('subtitle').innerHTML += product.d2c362a22b4628842cb19563a4fd19337b27189e ? product.d2c362a22b4628842cb19563a4fd19337b27189e.name : 'un chasseur inconnu';
      document.getElementById('subtitle').innerHTML += ' le ' + new Date(product.add_time).toLocaleDateString('fr-FR');
      ['/Documents de vente/Documents copropriete', '/Documents de vente/Documents opportunite', '/Autre'].forEach(id => {
        getFiles(id)
          .then(hits => {
            if (hits.hits) {
              hits.hits.forEach((hit, i) => {
                if (!hit._source.isDirectory) {
                  document.getElementById(id.replace('/Autre', 'Autre')).innerHTML  +=
                    '<div class="p-3 w-25">' +
                      '<div class="card">' +
                        '<img class="card-img-top" src="https://immocitiz.sirv.com' + hit._source.filename + '?profile=visuel">' +
                        '<div class="card-body d-flex align-items-center flex-wrap justify-content-between">' +
                          '<p class="card-text mb-0">Autre<br>visuel n°' + i + '</p>' +
                          '<div class="btn-group">' +
                            '<a class="btn btn-outline-secondary" href="https://immocitiz.sirv.com' + hit._source.filename + '" target="_blank">' +
                              '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">' +
                                '<path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>' +
                              '</svg>' +
                            '</a>' +
                            '<button class="btn btn-outline-secondary" onclick="deleteFile(\'https://immocitiz.sirv.com' + encodeURI(hit._source.filename) + '\');" type="button">' +
                              '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">' +
                                '<path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"/>' +
                                '<path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"/>' +
                              '</svg>' +
                            '</buton>' +
                          '</div>' +
                        '</div>' +
                      '</div>' +
                    '</div>';
                }
              });
            }
          });
      });
      ['/Visuel 1', '/Visuel 2', '/Visuel 3', '/Visuel 4', '/Visuel 5', '/Visuel 6'].forEach(id => {
        getVisuelUrl(id)
          .then(url => {
            document.getElementById(id).innerHTML =
              '<div class="card">' +
                '<img class="card-img-top" src="' + url + '">' +
                '<div class="card-body d-flex align-items-center flex-wrap justify-content-between">' +
                  '<p class="card-text mb-0">' + id.split('/')[id.split('/').length - 1].replace('Visuel ', 'Visuel n°') + '</p>' +
                  '<div class="btn-group">' +
                    '<a class="btn btn-outline-secondary" href="' + url + '" target="_blank">' +
                      '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">' +
                        '<path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>' +
                      '</svg>' +
                    '</a>' +
                    '<button class="btn btn-outline-secondary" onclick="deleteFile(\'' + encodeURI(url) + '\');" type="button">' +
                      '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">' +
                        '<path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"/>' +
                        '<path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"/>' +
                      '</svg>' +
                    '</buton>' +
                  '</div>' +
                '</div>' +
              '</div>';
          });
      });
    };
    getProduct();

    const getToken = async _ => {
      const response = await fetch('https://api.sirv.com/v2/token', {
        method: 'POST',
        body: JSON.stringify({
          "clientId": new URLSearchParams(window.location.search).get('s1'),
          "clientSecret": new URLSearchParams(window.location.search).get('s2')
        }),
        headers: {
          'content-type': 'application/json'
        }
      });
      let responseJson = await response.json();
      token = responseJson.token;
    }
    getToken();

    const getFiles = async id => {
      try {
        const response = await fetch('https://api.sirv.com/v2/files/search', {
          method: 'POST',
          body: JSON.stringify({
            "query": "dirname:\\/" + product.d74428a0196cace86d45a83a9526935ffe7b2415.substring(29) + id  + " AND -dirname:\\/.Trash"
          }),
          headers: {
            'content-type': 'application/json',
            'authorization': 'Bearer' + token
          }
        });
        let responseJson = await response.json();
        return responseJson;
      } catch (error) {
        console.error('Error:', error);
        return null;
      }
    }

    const getVisuelUrl = async id => {
      try {
        const response = await fetch('https://api.sirv.com/v2/files/search', {
          method: 'POST',
          body: JSON.stringify({
            "query": "dirname:\\/" + product.d74428a0196cace86d45a83a9526935ffe7b2415.substring(29) + id  + " AND -dirname:\\/.Trash"
          }),
          headers: {
            'content-type': 'application/json',
            'authorization': 'Bearer' + token
          }
        });
        let responseJson = await response.json();
        return encodeURI(
          'https://immocitiz.sirv.com/' +
          product.d74428a0196cace86d45a83a9526935ffe7b2415.substring(29) +
          id +
          '/' +
          responseJson.hits[1]._source.basename +
          '?profile=visuel'
        );
      } catch (error) {
        console.error('Error:', error);
        return null;
      }
    }

    const getImageAsBinary = async url => {
      try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const binaryContent = new Uint8Array(arrayBuffer);
        return binaryContent;
      } catch (error) {
        console.error('Error:', error);
        return null;
      }
    }

    const uploadFile = async (e, output, binaryContent) => {
      try {
        const response = await fetch(
          'https://api.sirv.com/v2/files/upload?filename=%2F' +
          product.d74428a0196cace86d45a83a9526935ffe7b2415.substring(29).replace('/', '%2F') +
          e.detail.ctx +
          output.name, {
            method: 'POST',
            body: binaryContent,
            headers: {
              'content-type': output.mimeType,
              'authorization': 'Bearer' + token
            }
          }
        );
        const uploadedFile = await response.json();
        return uploadedFile;
      } catch (error) {
        console.error('Error:', error);
        return null;
      }
    }

    const deleteFile = async (url) => {
      if (confirm('Êtes-vous sûr de vouloir supprimer ce visuel ?')) {
        try {
          const response = await fetch(
            'https://api.sirv.com/v2/files/delete?filename=%2F' +
            decodeURI(url).substring(27, decodeURI(url).length - 15).replace('/', '%2F'), {
              method: 'POST',
              body: {},
              headers: {
                'content-type': 'application/json',
                'authorization': 'Bearer' + token
              }
            }
          );
          const deletedFile = await response;
          setTimeout(_ => location.reload(), 3000);
          return deletedFile;
        } catch (error) {
          console.error('Error:', error);
          return null;
        }
      }
    }

    window.addEventListener('LR_DATA_OUTPUT', e => {
      e.detail.data.forEach(output => {
        getImageAsBinary(output.cdnUrl)
          .then(binaryContent => {
            uploadFile(e, output, binaryContent)
              .then(_ => setTimeout(_ => location.reload(), 3000))
              .catch(error => console.error('Error:', error))
          })
          .catch(error => console.error('Error:', error));
      });
    });
  </script>

  <script type="module">
    import * as LR from "https://esm.sh/@uploadcare/blocks@0.21.7/web/file-uploader-regular.min.js";

    LR.registerBlocks(LR);
  </script>

  <style>
    .multiple-max-1 {
      --cfg-pubkey: "e2d5f890d44d15ce657b";
      --cfg-img-only: 1;
      --cfg-multiple: 0;
      --cfg-max-local-file-size-bytes: 10485760;
      --cfg-multiple-max: 1;
      --cfg-use-cloud-image-editor: 1;
      --cfg-source-list: "local, url, camera, dropbox, gdrive";
      --darkmode: 0;
      --h-accent: 210;
      --s-accent: 61%;
      --l-accent: 43%;
    }

    .no-multiple-max {
      --cfg-pubkey: "e2d5f890d44d15ce657b";
      --cfg-img-only: 1;
      --cfg-multiple: 1;
      --cfg-max-local-file-size-bytes: 10485760;
      --cfg-use-cloud-image-editor: 1;
      --cfg-source-list: "local, url, camera, dropbox, gdrive";
      --darkmode: 0;
      --h-accent: 210;
      --s-accent: 61%;
      --l-accent: 43%;
    }
  </style>
</body>

</html>
